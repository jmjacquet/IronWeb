services:
  ironweb:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ironweb
    restart: unless-stopped
    environment:
      PYTHONUNBUFFERED: 1
      DEBUG: ${DEBUG:-False}
      GUNICORN_WSGI: ${GUNICORN_WSGI:-ggcontable.wsgi:application}
      DB_HOST: ${DB_HOST:-mariadb_ironweb}
      DB_PORT: ${DB_PORT:-3306}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      SECRET_KEY: ${SECRET_KEY}
      SESSION_COOKIE_NAME: ${SESSION_COOKIE_NAME:-ironweb_session}
      SERVER_EMAIL: ${SERVER_EMAIL}
      DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL}
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-6}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-3}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-120}
      GUNICORN_BIND: ${GUNICORN_BIND:-0.0.0.0:8000}
      COLLECT_STATIC: ${COLLECT_STATIC:-false}
    volumes:
      - ironweb_static:/app/static
      - ironweb_media:/app/media
      - ironweb_logs:/app/logs
    networks:
      - dokploy-network
    labels:
      - traefik.docker.network=dokploy-network
      - traefik.enable=true
      - traefik.http.services.ironweb.loadbalancer.server.port=8000
      # HTTPS (existing)
      - traefik.http.routers.ironweb.rule=HostRegexp(`{host:([a-z0-9-]+\\.)?ironwebgestion\\.com\\.ar}`)
      - traefik.http.routers.ironweb.entrypoints=websecure
      - traefik.http.routers.ironweb.tls=true
      - traefik.http.routers.ironweb.tls.certresolver=letsencrypt
      # HTTP â†’ redirect to HTTPS
      - traefik.http.middlewares.ironweb-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.ironweb-redirect.redirectscheme.permanent=true
      - traefik.http.routers.ironweb-http.rule=HostRegexp(`{host:([a-z0-9-]+\\.)?ironwebgestion\\.com\\.ar}`)
      - traefik.http.routers.ironweb-http.entrypoints=web
      - traefik.http.routers.ironweb-http.middlewares=ironweb-redirect
      - traefik.http.routers.ironweb-http.service=ironweb

volumes:
  ironweb_static:
    driver: local
    name: ironweb_static
  ironweb_media:
    driver: local
    name: ironweb_media
  ironweb_logs:
    driver: local
    name: ironweb_logs

networks:
  dokploy-network:
    external: true